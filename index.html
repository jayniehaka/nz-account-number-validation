<!DOCTYPE html>
<html>
<head>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <style>
    .alert {
        padding: 6px 6px;
        margin-bottom: 0px;
        margin-top: 20px;
    }

    .alert .glyphicon{
        display:table-cell;
        padding: 0px 12px;
    }

    .alert div,
    .alert span{
        padding-left: 5px;
        display:table-cell;
    }
    </style>

    <title>Validate a NZ Bank Account Number</title>
</head>
<body>

<div class="container">
    <div class="row">
        <h1 align="center">Validate a NZ Bank Account Number</h1>
    </div>

    <div class="row">
        <div class="col-md-1 col-md-offset-2">
            <h4>Bank</h4>
        </div>
        <div class="col-md-2">
            <h4>Branch</h4>
        </div>
        <div class="col-md-2">
            <h4>Base number</h4>
        </div>
        <div class="col-md-1">
            <h4>Suffix</h4>
        </div>
    </div>

<form id="accountNumberForm">
    <div class="row">
        <div class="col-md-1 col-md-offset-2">
            <input class="form-control" placeholder="Bank" type="text" maxlength=2 id="bank">
        </div>
        <div class="col-md-2">
            <input class="form-control" placeholder="Branch" type="text" maxlength=4 id="branch">
        </div>
        <div class="col-md-2">
            <input class="form-control" placeholder="Base number" type="text" maxlength=8 id="base">
        </div>
        <div class="col-md-1">
            <input class="form-control" placeholder="Suffix" type="text" maxlength=4 id="suffix">
        </div>
        <div class="col-md-1">
            <button class="btn btn-block" type="button" onclick="validate()">Check</button>
        </div>
        <div class="col-md-1">
            <button class="btn btn-block" type="button" onclick="clearAccount()">Clear</button>
        </div>
    </div>
</form>

    <div class="row">
        <div class="col-md-4 col-md-offset-4">
            <div id="output1">
                <span id="icon1"></span><span id="text1"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 col-md-offset-4">
            <div id="output2">
                <span id="icon2"></span><span id="text2"></span>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
    
    // thanks Nicko for this bit
    $('#bank').on('paste', function (e) {
      // if you paste in the bank box, grab text from clipboard
      var clip = e.originalEvent.clipboardData;
      var textData = clip.getData('text/plain');
       
      // split account number
      var accountParts = textData.trim().split(/[\s\-]+/)
      
      $('#bank').val(accountParts[0])
      $('#branch').val(accountParts[1])
      $('#base').val(accountParts[2])
      $('#suffix').val(accountParts[3])
      
    })

    function clearAccount() {
        document.getElementById("text1").innerHTML = "";
        document.getElementById("icon1").removeAttribute("class");
        document.getElementById("output1").removeAttribute("class");
        document.getElementById("text2").innerHTML = "";
        document.getElementById("icon2").removeAttribute("class");
        document.getElementById("output2").removeAttribute("class");
        document.getElementById("accountNumberForm").reset();
    }

    function validate() {
        var bankNum = document.getElementById("bank").value,
        branchNum = document.getElementById("branch").value,
        baseNum = document.getElementById("base").value,
        suffixNum = document.getElementById("suffix").value;
        
        // pad out with zeroes to make account number correct length
        var bankStr = padWithZeroes(bankNum, 2),
        branchStr = padWithZeroes(branchNum, 4),
        baseStr = padWithZeroes(baseNum, 8),
        suffixStr = padWithZeroes(suffixNum, 4);

        // put padded numbers back into boxes
        bankNum = document.getElementById("bank").value = bankStr;
        branchNum = document.getElementById("branch").value = branchStr;
        baseNum = document.getElementById("base").value = baseStr;
        suffixNum = document.getElementById("suffix").value = suffixStr;

        // put together into vector
        var accNumStr = bankStr + branchStr + baseStr + suffixStr;

        // calculate checksum
        var checksumResult = checkSum(bankNum, baseNum, accNumStr);

        // output message
        if (checksumResult == true) {
            var checkSumMessage = "Checksum is valid",
            checkSumMsgClass = "alert alert-success",
            checkSumIconClass = "glyphicon glyphicon-ok";
        } else {
            var checkSumMessage = "Checksum is not valid",
            checkSumMsgClass = "alert alert-danger",
            checkSumIconClass = "glyphicon glyphicon-remove";
        }

        document.getElementById("output1").className = checkSumMsgClass;
        document.getElementById("icon1").className = checkSumIconClass;
        document.getElementById("text1").innerHTML = checkSumMessage;

        var paymentsNZResult = true

        // get branch
            //concatenate bank and branch

        // lookup branch in list
        // if it exists, get name
        // otherwise, not valid

        // output message
        if (paymentsNZResult == true) {
            var paymentsNZMessage = "Bank and branch is valid",
            paymentsNZMsgClass = "alert alert-success";
            paymentsNZIconClass = "glyphicon glyphicon-ok";
        } else {
            var paymentsNZMessage = "Invalid bank and branch",
            paymentsNZMsgClass = "alert alert-danger";
            paymentsNZIconClass = "glyphicon glyphicon-remove";
        }

        document.getElementById("output2").className = paymentsNZMsgClass
        document.getElementById("icon2").className = paymentsNZIconClass
        document.getElementById("text2").innerHTML = paymentsNZMessage;
    }

    function padWithZeroes(n, width) {
      n = n + '';
      return n.length >= width ? n : new Array(width - n.length + 1).join("0") + n;
    }

    function checkSum(bankNum, baseNum, accNumStr) {
        var accNumArray = accNumStr.split("").map(Number);

        if (bankNum == 8) {
            // algorithm D
            var checkSumArray = [0,0,0,0,0,0,0,7,6,5,4,3,2,1,0,0,0,0],
            modulo = 11;
        } else if (bankNum == 9) {
            var checkSumArray = [0,0,0,0,0,0,0,0,0,0,5,4,3,2,0,0,0,1],
            modulo = 11;
        } else if (bankNum == 25 || bankNum == 33) {
            // algorithm F
            var checkSumArray = [0,0,0,0,0,0,0,1,7,3,1,7,3,1,0,0,0,0],
            modulo = 10;
        } else if (bankNum == 26 || bankNum == 28 || bankNum == 29) {
            // algorithm G
            var checkSumArray = [0,0,0,0,0,0,0,1,3,7,1,3,7,1,0,3,7,1],
            modulo = 10;
        } else if (bankNum == 31) {
            // algorithm X
            var checkSumArray = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            modulo = 1;
        } else if (baseNum < 990000) {
            // algorithm A
            var checkSumArray = [0,0,6,3,7,9,0,0,10,5,8,4,2,1,0,0,0,0],
            modulo = 11;
        } else {
            // algorithm B
            var checkSumArray = [0,0,0,0,0,0,0,0,10,5,8,4,2,1,0,0,0,0],
            modulo = 11;
        }

        var sum = 0;
        for(var i=0; i< accNumArray.length; i++) {
            sum += accNumArray[i]*checkSumArray[i];
        }

        var accNum = Number(accNumStr);

        if  (accNum == 0) {
            return false;
        } else if (sum % modulo == 0) {
            return true;
        } else {
            return false;
        }

    }

    function paymentsNZCheck() {
        // check bank and brank numbers on Payments NZ list
        // http://www.paymentsnz.co.nz/cms_show_download.php?id=222
        // look up branch number and find bank number. If bank number matches, return branch name and address
        // if branch exists but bank does not match, return "bank and branch number combination is not valid"
        // if branch does not exist, return "invalid branch number"
    }

</script>
</body>
</html>